<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mock Test Online</title>
  <style>
    :root {
      /* Base (Dark) */
      --bg: #0b0f14;
      --card: #121821;
      --muted: #8aa0b4;
      --text: #e6eef6;
      --accent: #4da3ff;
      --accent-2: #83e0a5;
      --danger: #ff6b6b;
      --warning: #ffd166;
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radial1: #1a2430;
      --radial2: #151a22;
    }

    /* ===== THEME VARIANTS ===== */
    html[data-theme="dark"] { --bg:#0b0f14; --card:#121821; --text:#e6eef6; --muted:#8aa0b4; --accent:#4da3ff; --accent-2:#83e0a5; --radial1:#1a2430; --radial2:#151a22; }
    html[data-theme="midnight"] { --bg:#0a0a12; --card:#131326; --text:#e8e9ff; --muted:#9aa0c8; --accent:#6a6cff; --accent-2:#7ee7d1; --radial1:#1b1b33; --radial2:#101020; }
    html[data-theme="forest"] { --bg:#0b120e; --card:#111a15; --text:#e9f6ee; --muted:#92b3a0; --accent:#49d17a; --accent-2:#7fd2ff; --radial1:#1a2a20; --radial2:#0e1712; }
    html[data-theme="ocean"] { --bg:#061219; --card:#0c1c26; --text:#e6f7ff; --muted:#8db5c7; --accent:#25b7ff; --accent-2:#7ff1b2; --radial1:#0e2a3a; --radial2:#071821; }
    html[data-theme="light"] { --bg:#f6f8fb; --card:#ffffff; --text:#13202c; --muted:#5d748a; --accent:#2b7fff; --accent-2:#1dbf73; --radial1:#e6eef6; --radial2:#f1f5f9; }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 20% -10%, var(--radial1), transparent),
                  radial-gradient(1200px 800px at 120% 20%, var(--radial2), transparent),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
    }
    .container { max-width: 980px; margin: 32px auto; padding: 0 16px 100px; }

    header { display: grid; gap: 14px; grid-template-columns: 1fr; margin-bottom: 18px; }
    .title { font-size: clamp(24px, 2.6vw, 36px); font-weight: 800; letter-spacing: .2px; line-height: 1.2; display: flex; align-items: center; gap: 12px; }

    .topbar { display:flex; gap:10px; align-items:center; justify-content: space-between; }
    .tabs { display:flex; gap:8px; align-items:center; }
    .tab { appearance:none; border:1px solid #324357; background:transparent; color:var(--text); padding:8px 12px; border-radius:999px; font-weight:750; cursor:pointer; }
    .tab.active { background: var(--accent); color:#071018; border-color: transparent; }
    .tab[disabled] { opacity:.55; cursor:not-allowed; pointer-events:none; }

    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)), var(--card); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); box-shadow: var(--shadow); }
    .toolbar { padding: 14px; display: grid; gap: 12px; }
    .toolbar .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .toolbar input[type="text"], .toolbar input[type="number"], .toolbar select { background: #0e141c; border: 1px solid #2a3646; color: var(--text); border-radius: 10px; padding: 10px 12px; outline: none; min-width: 180px; }
    html[data-theme="light"] .toolbar input[type="text"],
    html[data-theme="light"] .toolbar input[type="number"],
    html[data-theme="light"] .toolbar select { background: #f0f4f8; border-color: #c7d2de; color: #13202c; }
    .toolbar input[type="checkbox"] { transform: translateY(1px); }

    .btn { appearance: none; border: none; cursor: pointer; font-weight: 750; padding: 10px 14px; border-radius: 12px; color: #071018; background: var(--accent); transition: transform .05s ease, filter .2s; }
    .btn.secondary { background: #2b3b4f; color: var(--text); }
    .btn.ghost { background: transparent; color: var(--text); border: 1px solid #324357; }
    html[data-theme="light"] .btn.secondary { background: #e9eef5; color: #13202c; }
    html[data-theme="light"] .btn.ghost { color: #13202c; border-color: #c7d2de; }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity:.55; cursor:not-allowed; filter: grayscale(0.2); }

    .quiz { margin-top: 14px; }
    .qcard { padding: 18px 18px; margin-bottom: 12px; }
    .qhead { display: flex; justify-content: space-between; gap: 10px; align-items: center; margin-bottom: 8px; }
    .qleft { display:flex; gap:8px; align-items: baseline; flex-wrap: wrap; }
    .qtitle { font-weight: 700; font-size: 16px; line-height: 1.4; white-space: pre-line; }
    .qnum { color: var(--muted); font-weight: 700; }
    .choices { display: grid; gap: 8px; margin-top: 8px; }
    .choice { display: flex; gap: 10px; align-items: flex-start; border: 1px solid #263246; border-radius: 12px; padding: 10px 12px; background: #0e141c; }
    html[data-theme="light"] .choice { background:#f7fafc; border-color:#d7e1ea; }
    .choice input { transform: translateY(4px); }
    .choice label { cursor: pointer; display: block; }

    .tag { font-size:12px; color: var(--muted); border:1px solid #2a3646; border-radius:999px; padding:4px 8px; }
    html[data-theme="light"] .tag { border-color: #c7d2de; color:#5d748a; }

    .footerbar { position: sticky; bottom: 12px; z-index: 10; margin-top: 18px; }
    .footerbar .inner { display: flex; gap: 10px; justify-content: space-between; align-items: center; padding: 10px; border-radius: 14px; background: rgba(10,16,22,0.72); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.08); }
    html[data-theme="light"] .footerbar .inner { background: rgba(255,255,255,0.8); border-color: rgba(17,24,39,0.06); }
    .stats { display: flex; gap: 12px; color: var(--muted); font-weight: 700; font-variant-numeric: tabular-nums; }
    .pill { padding: 6px 10px; border: 1px solid #2a3646; border-radius: 999px; }
    html[data-theme="light"] .pill { border-color:#c7d2de; }

    .correct { border-color: rgba(131,224,165,.55) !important; box-shadow: inset 0 0 0 1px rgba(131,224,165,.3); }
    .incorrect { border-color: rgba(255,107,107,.5) !important; box-shadow: inset 0 0 0 1px rgba(255,107,107,.3); }

    .result { margin-top: 18px; padding: 16px; border-radius: 14px; background: #0d1621; border: 1px solid #213042; }
    html[data-theme="light"] .result { background:#ffffff; border-color:#d7e1ea; }
    .result h3 { margin: 0 0 8px; }
    .answersheet { display: grid; grid-template-columns: repeat(auto-fit, minmax(44px, 1fr)); gap: 8px; margin-top: 10px; }
    .answersheet .box { text-align: center; padding: 8px 0; border: 1px solid #2a3646; border-radius: 10px; font-weight: 800; }
    .answersheet .ok { background: rgba(131,224,165,.12); border-color: rgba(131,224,165,.6); }
    .answersheet .no { background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.6); }
    .answersheet .nk { opacity: .6; }

    details { margin-top: 14px; }
    details summary { cursor: pointer; user-select: none; color: var(--muted); }

    .empty { padding: 20px; border: 1px dashed #2a3646; border-radius: 12px; color: var(--muted); text-align: center; }

    [hidden] { display: none !important; }

    @media (max-width: 640px) {
      .toolbar .row { flex-direction: column; align-items: stretch; }
      .toolbar input[type="text"], .toolbar input[type="number"], .toolbar select { width: 100%; }
      .btn { width: 100%; }
    }

    /* ===== Modal ===== */
    .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(3,7,12,0.6); backdrop-filter: blur(2px); z-index: 100; }
    .modal-card { width: min(720px, 92vw); background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; box-shadow: var(--shadow); }
    .modal-head { padding: 14px 16px; display:flex; justify-content: space-between; align-items:center; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .modal-body { padding: 14px 16px; display:grid; gap:12px; }
    .modal-foot { padding: 12px 16px; display:flex; gap:8px; justify-content:flex-end; border-top: 1px solid rgba(255,255,255,0.06); }
    .seg { display:flex; gap:8px; flex-wrap: wrap; }
    .seg .segbtn { padding:8px 12px; border-radius:999px; border:1px solid #2a3646; background:transparent; color:var(--text); cursor:pointer; font-weight:750; }
    .seg .segbtn.active { background: var(--accent); color:#071018; border-color: transparent; }
    textarea.input, input.input { width:100%; min-height: 120px; background:#0e141c; color:var(--text); border:1px solid #263246; border-radius:12px; padding:10px; }
    input.input { min-height: unset; height: 40px; }
    .hint { color: var(--muted); font-size: 13px; }
    .dropzone { border:2px dashed #2a3646; border-radius:12px; padding:18px; text-align:center; }
    .close-x { appearance:none; border:none; background:transparent; color:var(--muted); font-size:22px; cursor:pointer; }
    html[data-theme="light"] textarea.input, html[data-theme="light"] input.input { background:#f7fafc; color:#13202c; border-color:#d7e1ea; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">Mock Test Online</div>
      <div class="topbar">
        <div class="tabs">
          <button id="tab-setup" class="tab">ตั้งค่า</button>
          <button id="tab-quiz" class="tab">ทำข้อสอบ</button>
          <button id="tab-result" class="tab" disabled>ผลคะแนน</button>
        </div>
        <div>
          <select id="themePicker" title="ธีม" style="min-width: 180px">
            <option value="dark">ธีม: Dark</option>
            <option value="midnight">ธีม: Midnight</option>
            <option value="forest">ธีม: Forest</option>
            <option value="ocean">ธีม: Ocean</option>
            <option value="light">ธีม: Light</option>
          </select>
        </div>
      </div>
    </header>

    <!-- ===== View: SETUP ===== -->
    <section id="view-setup" class="card toolbar">
      <div class="row">
        <input id="quizTitle" type="text" placeholder="ชื่อวิชา/แบบทดสอบ" value="Mock Test" />
        <label class="pill"><input id="shuffle" type="checkbox" /> สุ่มข้อ</label>
        <label class="pill"><input id="requireAll" type="checkbox" /> บังคับตอบทุกข้อ</label>
        <label class="pill"><input id="enableTimer" type="checkbox" /> จับเวลา (นาที)</label>
        <input id="timerMinutes" type="number" min="1" value="10" style="width:90px" />
        <button class="btn" id="startBtn">เริ่มทำข้อสอบ</button>
      </div>
      <div class="row">
        <button class="btn ghost" id="uploadJsonBtn" title="อัปโหลดไฟล์ JSON">อัปโหลด JSON</button>
        <input id="fileQuestions" type="file" accept="application/json" multiple hidden />
        <button class="btn ghost" id="importBtn" title="วาง JSON (Paste)">วาง JSON</button>
        <button class="btn ghost" id="importAnsBtn" title="นำเข้าเฉลย">นำเข้าเฉลย</button>
        <button class="btn ghost" id="exportAnsTemplateBtn" title="ส่งออกเทมเพลตเฉลย (CSV)">ดาวน์โหลดเทมเพลตเฉลย</button>
        <button class="btn ghost" id="exportBtn" title="ดาวน์โหลด JSON รวม">ดาวน์โหลด JSON รวม</button>
      </div>

      <details open>
        <summary>ชุดข้อสอบที่อัปโหลด (ตั้งหมวด/เกณฑ์ต่อชุด)</summary>
        <div id="setsList" style="display:grid; gap:10px; margin-top:10px"></div>
      </details>

      <details>
        <summary>โครงสร้าง JSON/CSV เฉลย ที่รองรับ</summary>
        <div style="color:var(--muted); font-size:14px; margin-top:8px; line-height:1.6">
          <b>JSON</b> (ตัวอย่างการวาง): <code>1:A, 2 C, 3-ก</code><br/>
          <b>CSV</b>: มีคอลัมน์อย่างน้อย <code>id</code> และ <code>answer</code> (รองรับชื่อคอลัมน์หลายแบบ เช่น <code>id|no|ข้อ</code> กับ <code>answer|ans|คำตอบ</code>)
<pre style="white-space:pre; overflow:auto; background:#0e141c; padding:10px; border-radius:10px; border:1px solid #2a3646">id,answer
1,A
2,ก
3,C</pre>
          <b>Google Sheets</b>: วางลิงก์แผ่นงาน แล้วระบบจะแปลงเป็น CSV อัตโนมัติ (แนะนำตั้งค่า "Publish to the web" หรือใช้ลิงก์ที่มี <code>gid</code>)
        </div>
      </details>
    </section>

    <!-- ===== View: QUIZ ===== -->
    <section id="view-quiz" hidden>
      <main id="app"></main>
      <div class="footerbar">
        <div class="inner">
          <div class="stats">
            <span id="progress" class="pill">ยังไม่ได้โหลดข้อสอบ</span>
            <span id="clock" class="pill" title="ตัวจับเวลา">00:00</span>
          </div>
          <div>
            <button class="btn secondary" id="backBtn" title="กลับไปหน้าตั้งค่า">หน้าตั้งค่า</button>
            <button class="btn secondary" id="resetBtn">เริ่มใหม่</button>
            <button class="btn" id="submitBtn">ส่งคำตอบ</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== View: RESULT ===== -->
    <section id="view-result" hidden>
      <div id="resultWrap" class="result card">
        <h3>ผลคะแนน</h3>
        <div id="resSummary" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;"></div>
        <details open>
          <summary>เฉลย (บอกเฉพาะตัวเลือกที่ถูก)</summary>
          <div class="answersheet" id="resSheet"></div>
        </details>
        <details>
          <summary>สรุปผลตามชุด/หมวด</summary>
          <div id="resBySet" style="display:grid; gap:6px; margin-top:8px"></div>
        </details>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn secondary" id="goToQuiz">ดูข้อสอบ</button>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== Modal: Import Answers ===== -->
  <section id="ansModal" class="modal" hidden>
    <div class="modal-card">
      <div class="modal-head">
        <strong>นำเข้าเฉลย</strong>
        <button class="close-x" id="ansModalClose" aria-label="ปิด">×</button>
      </div>
      <div class="modal-body">
        <div class="seg">
          <button class="segbtn active" id="tabAnsText">พิมพ์วาง (ข้อความ)</button>
          <button class="segbtn" id="tabAnsCSV">วาง CSV</button>
          <button class="segbtn" id="tabAnsSheet">ลิงก์ Google Sheets</button>
          <button class="segbtn" id="tabAnsFile">อัปโหลดไฟล์ CSV</button>
        </div>
        <div id="panelAnsText">
          <textarea id="ansText" class="input" placeholder="ตัวอย่าง\n1:A, 2 C, 3-D\nหรือ\n1 A\n2 ก\n3 C"></textarea>
          <div class="hint">รองรับตัวเลือก 1–4, A–D, หรือ ก–ง</div>
        </div>
        <div id="panelAnsCSV" hidden>
          <textarea id="ansCsvText" class="input" placeholder="วางข้อมูล CSV ที่มีคอลัมน์ id,answer\nเช่น\nid,answer\n1,A\n2,ก\n3,C"></textarea>
          <div class="hint">ถ้าไม่มีหัวคอลัมน์ ระบบจะเดา <code>คอลัมน์ที่ 1 = id</code>, <code>คอลัมน์ที่ 2 = answer</code></div>
        </div>
        <div id="panelAnsSheet" hidden>
          <input id="ansSheetUrl" class="input" placeholder="วางลิงก์ Google Sheets ที่เปิดสิทธิ์อ่านได้" />
          <div class="hint">ระบบจะแปลงเป็น CSV อัตโนมัติ</div>
        </div>
        <div id="panelAnsFile" hidden>
          <div class="dropzone">
            <input id="ansFile" type="file" accept=".csv,text/csv" />
            <div class="hint">เลือกไฟล์ .csv ที่บันทึกจาก Excel/Sheets</div>
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn secondary" id="ansModalCancel">ยกเลิก</button>
        <button class="btn" id="ansModalImport">นำเข้า</button>
      </div>
    </div>
  </section>

  <script>
    // =========================
    // Helpers
    // =========================
    const $ = (sel, root=document) => root.querySelector(sel);
    function bind(id, event, handler){ const el=document.getElementById(id); if(!el) return null; el.addEventListener(event, handler); return el; }

    // =========================
    // 0) Theme + Router
    // =========================
    function applyTheme(name) {
      document.documentElement.setAttribute('data-theme', name);
      try { localStorage.setItem('quiz_theme', name); } catch(_){ }
    }
    function initTheme() {
      const saved = (localStorage.getItem('quiz_theme') || 'dark');
      const picker = document.getElementById('themePicker');
      if (picker) { picker.value = saved; }
      applyTheme(saved);
    }

    function showView(name) {
      const setup = document.getElementById('view-setup');
      const quiz = document.getElementById('view-quiz');
      const result = document.getElementById('view-result');
      const tabSetup = document.getElementById('tab-setup');
      const tabQuiz = document.getElementById('tab-quiz');
      const tabResult = document.getElementById('tab-result');

      if (name === 'setup' && state.locked) {
        alert('เริ่มทำข้อสอบแล้ว จึงไม่สามารถกลับไปหน้าตั้งค่าได้');
        name = 'quiz';
      }

      setup.hidden = name !== 'setup';
      quiz.hidden = name !== 'quiz';
      result.hidden = name !== 'result';

      tabSetup?.classList.toggle('active', name==='setup');
      tabQuiz?.classList.toggle('active', name==='quiz');
      tabResult?.classList.toggle('active', name==='result');

      if (name==='result') location.hash = '#result';
      else if (name==='quiz') location.hash = '#quiz';
      else location.hash = '#setup';

      window.scrollTo({top:0, behavior:'smooth'});
    }
    function initRouter() {
      const h = (location.hash || '#setup').replace('#','');
      showView(h === 'quiz' ? 'quiz' : h === 'result' ? 'result' : 'setup');
      window.addEventListener('hashchange', () => {
        const hh = (location.hash || '#setup').replace('#','');
        if (state.locked && hh === 'setup') { showView('quiz'); return; }
        showView(hh === 'quiz' ? 'quiz' : hh === 'result' ? 'result' : 'setup');
      });
      bind('tab-setup','click', () => { if (state.locked) { alert('เริ่มทำข้อสอบแล้ว จึงไม่สามารถกลับไปหน้าตั้งค่าได้'); return; } showView('setup'); });
      bind('tab-quiz','click', () => showView('quiz'));
      bind('tab-result','click', () => showView('result'));
    }

    // =========================
    // 1) Data & State
    // =========================
    window.SETS = [];
    let NEXT_SID = 1;
    const state = { started:false, submitted:false, selections:{}, order:[], timer:null, remainingSec:0, locked:false };

    function shuffleArray(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function formatClock(sec){ const m=Math.floor(sec/60).toString().padStart(2,'0'); const s=(sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }

    function normalizeImported(input){
      if (Array.isArray(input)) {
        if (input.length===0) return [];
        if (input[0] && typeof input[0]==='object' && Array.isArray(input[0].choices)) {
          return input.map(q=>({ ...q }));
        }
        if (input[0] && typeof input[0]==='object' && Array.isArray(input[0].questions)) {
          const out=[]; for (const blk of input){ const g=blk.group||blk.name||blk.title||'ไม่ระบุหมวด'; for(const q of (blk.questions||[])){ out.push({ ...q, group: (q.group||g) }); } } return out;
        }
      }
      if (input && typeof input==='object' && !Array.isArray(input)){
        const out=[]; for (const [g, arr] of Object.entries(input)){ if (Array.isArray(arr)){ for (const q of arr){ out.push({ ...q, group: (q.group||g) }); } } } return out;
      }
      throw new Error('รูปแบบไฟล์ไม่รองรับ');
    }

    function validateQuestions(list){
      if(!Array.isArray(list)) throw new Error('ข้อมูลไม่ใช่อาร์เรย์');
      for (const q of list){
        if(!q || typeof q!== 'object') throw new Error('พบรายการที่ไม่ใช่วัตถุ');
        if(q.text==null || q.id==null || !Array.isArray(q.choices)) throw new Error('ข้อมูลไม่ครบ (id, text, choices)');
        for (const c of q.choices){ if(!c || c.key==null || c.text==null) throw new Error('choices ต้องมี key และ text'); }
      }
      return true;
    }

    function baseName(name){ return (name||'').replace(/^.*[\\\/]/,'').replace(/\.[^.]+$/,'') || 'ไม่ระบุชื่อ'; }

    function addSet({ filename, questions, groupName, passPercent=70, enabled=true }){
      validateQuestions(questions);
      const sid = NEXT_SID++;
      const set = { sid, filename, base: baseName(filename), groupName: groupName || baseName(filename), passPercent, enabled, questions: [...questions] };
      window.SETS.push(set);
      renderSetsList();
      return set;
    }

    function removeSet(sid){ window.SETS = window.SETS.filter(s=>s.sid!==sid); renderSetsList(); }

    function getAllQuestionsFlat(){
      const out=[]; for (const s of window.SETS){ for (const q of s.questions){ out.push({ ...q, group: (s.groupName || s.base) }); } } return out;
    }

    function renderSetsList(){
      const host = $('#setsList'); if (!host) return; host.innerHTML='';
      if (!window.SETS.length){ host.innerHTML = '<div class="empty">ยังไม่มีชุดข้อสอบ — อัปโหลด JSON ได้หลายชุด หรือวาง JSON</div>'; return; }
      for (const set of window.SETS){
        const row = document.createElement('div'); row.className='card qcard';
        row.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between">
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
              <label class="pill" title="ใช้ชุดนี้ในการสอบ"><input type="checkbox" data-act="toggle" ${set.enabled?'checked':''}/> ใช้ชุดนี้</label>
              <span class="tag" title="ชื่อไฟล์">${set.filename || '(วาง JSON)'}</span>
              <label class="pill" title="ตั้งชื่อหมวด/กลุ่ม"><span>หมวด:</span> <input type="text" data-act="group" value="${set.groupName}" style="width:200px; margin-left:6px" /></label>
              <label class="pill" title="เกณฑ์ผ่านของชุดนี้"><span>เกณฑ์ผ่าน (%)</span> <input type="number" data-act="pass" min="0" max="100" value="${set.passPercent}" style="width:80px; margin-left:6px" /></label>
              <span class="pill" title="จำนวนข้อ">${set.questions.length} ข้อ</span>
            </div>
            <div style="display:flex; gap:8px">
              <button class="btn ghost" data-act="export">ส่งออกชุดนี้</button>
              <button class="btn secondary" data-act="remove">ลบชุด</button>
            </div>
          </div>
        `;
        row.querySelector('[data-act="toggle"]').addEventListener('change', (e)=>{ set.enabled = e.target.checked; });
        row.querySelector('[data-act="group"]').addEventListener('input', (e)=>{ set.groupName = e.target.value; });
        row.querySelector('[data-act="pass"]').addEventListener('input', (e)=>{ const v=parseInt(e.target.value||'0',10); set.passPercent = Math.min(100, Math.max(0, isNaN(v)?0:v)); e.target.value=set.passPercent; });
        row.querySelector('[data-act="remove"]').addEventListener('click', ()=> removeSet(set.sid));
        row.querySelector('[data-act="export"]').addEventListener('click', ()=>{
          const data = JSON.stringify(set.questions, null, 2);
          const blob = new Blob([data], { type:'application/json' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${set.base || 'set'}.json`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
        });
        host.appendChild(row);
      }
    }

    function exportAllQuestions(){
      const data = JSON.stringify(getAllQuestionsFlat(), null, 2);
      const blob = new Blob([data], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `questions_all_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    }

    // =========================
    // 2) Render Quiz
    // =========================
    function renderQuiz(){
      const app = document.getElementById('app'); app.innerHTML='';
      if (!state.order.length){ app.innerHTML='<div class="empty">ยังไม่มีข้อสอบที่เลือกไว้</div>'; return; }
      const quizWrap = document.createElement('div'); quizWrap.className='quiz';

      state.order.forEach((q)=>{
        const qcard=document.createElement('div'); qcard.className='card qcard';
        const head=document.createElement('div'); head.className='qhead';

        const left=document.createElement('div'); left.className='qleft';
        const title=document.createElement('div'); title.className='qtitle'; title.innerText = q.text;
        left.appendChild(title);
        if (q.group) { const g=document.createElement('span'); g.className='tag'; g.textContent=q.group; left.appendChild(g); }

        const num=document.createElement('div'); num.className='qnum'; num.innerHTML = '';
        head.appendChild(left); head.appendChild(num); qcard.appendChild(head);

        const choices=document.createElement('div'); choices.className='choices';
        q.choices.forEach(ch=>{
          const id=`q${q.uid}_${ch.key}`; const row=document.createElement('div'); row.className='choice';
          const input=document.createElement('input'); input.type='radio'; input.name=`q_${q.uid}`; input.id=id; input.value=ch.key; input.checked = state.selections[q.uid]===ch.key; input.addEventListener('change',()=>{ state.selections[q.uid]=ch.key; updateProgress(); });
          const label=document.createElement('label'); label.htmlFor=id; label.innerHTML = `<b>${ch.key}.</b> ${ch.text}`;
          row.appendChild(input); row.appendChild(label); choices.appendChild(row);
        });
        qcard.appendChild(choices); quizWrap.appendChild(qcard);
      });
      app.appendChild(quizWrap); updateProgress();
    }

    // =========================
    // 3) Grade -> RESULT
    // =========================
    function grade(){
      const requireAll = document.getElementById('requireAll').checked;
      if (requireAll){ const unanswered = state.order.filter(q=>!state.selections[q.uid]); if (unanswered.length){ alert(`กรุณาตอบให้ครบทุกข้อ (คงเหลือ ${unanswered.length} ข้อ)`); return; } }
      state.submitted = true; let correct=0, gradable=0;

      const bySet = new Map();

      state.order.forEach(q=>{
        const chosen = state.selections[q.uid];
        if (!q.answer) return; // ไม่มีเฉลย ไม่นับคะแนน
        const isCorrect = toCanonKey(chosen)===toCanonKey(q.answer); gradable++; if (isCorrect) correct++;

        const s = bySet.get(q._sid) || { name:q._setName, filename:q._filename, passPercent:q._passPercent, correct:0, total:0 };
        s.total += 1; if (isCorrect) s.correct += 1; bySet.set(q._sid, s);
      });

      const total=state.order.length; const scorePct = gradable ? Math.round((correct/gradable)*100) : 0;

      const resSummary = document.getElementById('resSummary'); resSummary.innerHTML = '';
      const pills = [
        `ถูก ${correct} / ${gradable}`,
        `คิดเป็น ${scorePct}%`,
        `ชุดที่นำมาใช้ ${bySet.size} ชุด`,
        new Date().toLocaleString()
      ];
      for (const t of pills){ const d=document.createElement('div'); d.className='pill'; d.innerHTML=t; resSummary.appendChild(d); }

      const resBySet = document.getElementById('resBySet'); resBySet.innerHTML='';
      let allPass=true; for (const [sid, s] of bySet){ const pct = s.total ? Math.round((s.correct/s.total)*100) : 0; const pass = pct >= s.passPercent; allPass = allPass && pass; const line=document.createElement('div'); line.className='pill'; line.style.display='flex'; line.style.justifyContent='space-between'; line.style.alignItems='center'; line.innerHTML = `<span>${s.name} <span style="opacity:.7">(${s.filename})</span></span><span>${s.correct}/${s.total} (${pct}%) • เกณฑ์ ${s.passPercent}% → <b>${pass?'ผ่าน':'ไม่ผ่าน'}</b></span>`; resBySet.appendChild(line); }

      const resSheet = document.getElementById('resSheet'); resSheet.innerHTML='';
      state.order.forEach((q, idx)=>{ const box=document.createElement('div'); if (q.answer){ const ok=toCanonKey(state.selections[q.uid])===toCanonKey(q.answer); box.className=`box ${ok?'ok':'no'}`; box.textContent = `${idx+1}: ${q.answer}`; } else { box.className='box nk'; box.textContent = `${idx+1}: -`; } resSheet.appendChild(box); });

      const tabResult = document.getElementById('tab-result'); if (tabResult) tabResult.disabled = false;
      showView('result');

      if (!allPass) { console.info('บางชุดไม่ผ่านเกณฑ์ตามที่ตั้งไว้'); }
    }

    // =========================
    // 4) Controls & Timer
    // =========================
    function lockSetupUI(){
      const backBtn = document.getElementById('backBtn');
      if (backBtn) { backBtn.disabled = true; backBtn.title = 'เริ่มทำข้อสอบแล้ว ไม่สามารถกลับหน้าตั้งค่าได้'; }
      const tabSetup = document.getElementById('tab-setup');
      if (tabSetup) { tabSetup.disabled = true; tabSetup.title = 'ถูกล็อกหลังเริ่มทำข้อสอบ'; }
    }
    function unlockSetupUI(){
      const backBtn = document.getElementById('backBtn');
      if (backBtn) { backBtn.disabled = false; backBtn.title = 'กลับไปหน้าตั้งค่า'; }
      const tabSetup = document.getElementById('tab-setup');
      if (tabSetup) { tabSetup.disabled = false; tabSetup.title = ''; }
    }

    function start(){
      const title = document.getElementById('quizTitle').value.trim() || 'Mock Test'; document.title = title;

      const enabledSets = window.SETS.filter(s=>s.enabled);
      if (!enabledSets.length){ alert('ยังไม่ได้เลือกชุดข้อสอบ'); return; }

      const combined = [];
      for (const s of enabledSets){
        for (const q of s.questions){ combined.push({ ...q, uid:`${s.sid}:${q.id}`, _sid:s.sid, _setName:(s.groupName||s.base), _filename:(s.filename||s.base), _passPercent:s.passPercent, group:(s.groupName||s.base) }); }
      }

      if (!combined.length){ alert('ชุดที่เลือกไม่มีข้อสอบ'); return; }

      const shuffle = document.getElementById('shuffle').checked; state.order = shuffle ? shuffleArray(combined) : combined;
      state.selections={}; state.started=true; state.submitted=false;

      clearInterval(state.timer);
      if (document.getElementById('enableTimer').checked){ const minutes=Math.max(1, parseInt(document.getElementById('timerMinutes').value||'10',10)); state.remainingSec = minutes*60; state.timer = setInterval(()=>{ state.remainingSec--; if (state.remainingSec<=0){ clearInterval(state.timer); state.remainingSec=0; grade(); } updateClock(); },1000); } else { state.remainingSec=0; updateClock(); }

      state.locked = true; lockSetupUI();
      renderQuiz(); showView('quiz');
    }

    function resetAll(){
      clearInterval(state.timer); state.started=false; state.submitted=false; state.selections={}; state.order=[]; state.remainingSec=0;
      state.locked=false; unlockSetupUI();
      const progEl=document.getElementById('progress'); if (progEl) progEl.textContent = getAllQuestionsFlat().length ? `โหลดข้อสอบแล้ว ${getAllQuestionsFlat().length} ข้อ (รวมทุกชุด)` : 'ยังไม่ได้โหลดข้อสอบ';
      const clk=document.getElementById('clock'); if (clk) clk.textContent='00:00';
      const app=document.getElementById('app'); if (app) app.innerHTML = '<div class="empty">กด "เริ่มทำข้อสอบ" เพื่อเริ่ม</div>';
    }

    function updateProgress(){ if (!state.started) return; const answered = state.order.filter(q=>state.selections[q.uid]).length; const total = state.order.length; const el=document.getElementById('progress'); if (el) el.textContent = `ตอบแล้ว ${answered}/${total}`; }
    function updateClock(){ const el=document.getElementById('clock'); if (!el) return; if (state.remainingSec>0) el.textContent = formatClock(state.remainingSec); else el.textContent = 'ไม่จำกัดเวลา'; }

    // =========================
    // 5) Import/Export + Answers
    // =========================
    function mapThaiChoiceToLatin(ch){
      const dict = {
        'ก':'A','ข':'B','ค':'C','ง':'D',
        'a':'A','b':'B','c':'C','d':'D',
        '1':'A','2':'B','3':'C','4':'D'
      };
      return dict[(ch||'').toString().trim().toLowerCase()] || ch;
    }
    function toCanonKey(x){ return (mapThaiChoiceToLatin(x)||'').toString().trim().toUpperCase(); }

    function parseAnswerKey(raw){ const map={}; raw.split(/\n|,/).map(s=>s.trim()).filter(Boolean).forEach(tok=>{ const m=tok.match(/^(\d+)\s*[:\-\s=]?\s*([A-Da-dก-ง1-4])/); if(m){ const id=Number(m[1]); const key=toCanonKey(m[2]); map[id]=key; } }); return map; }

    // ----- CSV helpers -----
    function parseCSV(text){
      const rows=[]; let cur=[]; let val=''; let q=false; for(let i=0;i<text.length;i++){ const c=text[i]; if(q){ if(c==='"'){ if(text[i+1]==='"'){ val+='"'; i++; } else { q=false; } } else { val+=c; } } else { if(c==='"'){ q=true; } else if(c===','){ cur.push(val); val=''; } else if(c==='\n' || c==='\r'){ if(c==='\r' && text[i+1]==='\n') i++; cur.push(val); rows.push(cur); cur=[]; val=''; } else { val+=c; } } } cur.push(val); rows.push(cur); return rows.filter(r=>r.length && !(r.length===1 && r[0].trim()==='')); }

    function parseAnswerCSV(text){
      const rows=parseCSV(text); if(!rows.length) return {};
      const headerGuess=rows[0].map(h=>h.trim().toLowerCase());
      let idIdx = headerGuess.findIndex(h=>['id','qid','question id','question_id','no','ข้อ','หมายเลข'].includes(h));
      let ansIdx = headerGuess.findIndex(h=>['answer','ans','คำตอบ'].includes(h));

      let startRow = 1;
      if (idIdx===-1 || ansIdx===-1) {
        // ไม่มี header: เดาว่าเป็น 2 คอลัมน์ id,answer
        idIdx = 0; ansIdx = 1; startRow = 0;
      }
      const map={};
      for (let i=startRow;i<rows.length;i++){
        const id = Number((rows[i][idIdx]||'').toString().trim());
        const a = (rows[i][ansIdx]||'').toString().trim();
        if(!id||!a) continue;
        const key = toCanonKey(a);
        map[id]=key;
      }
      return map;
    }

    function applyAnswerMap(ans){
      let applied=0,skipped=0;
      window.SETS.forEach(set=>{
        set.questions.forEach(q=>{
          const k=ans[q.id];
          if(!k){ skipped++; return; }
          const target = toCanonKey(k);
          const match = q.choices.find(c=> toCanonKey(c.key) === target);
          if (match){ q.answer = match.key; applied++; }
          else { skipped++; }
        });
      });
      if(state.started) renderQuiz();
      return {applied, skipped};
    }

    function promptImport(){
      const hint=`วาง JSON รูปแบบที่รองรับ (ดูตัวอย่างใน "โครงสร้าง JSON ที่รองรับ")`;
      const raw=prompt(hint); if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        const flat = normalizeImported(parsed);
        const name = prompt('ตั้งชื่อชุด/หมวดสำหรับ JSON นี้', `วาง JSON #${window.SETS.length+1}`) || `วาง JSON #${window.SETS.length+1}`;
        addSet({ filename: name, questions: flat, groupName: name, passPercent: 70, enabled: true });
        alert('นำเข้า JSON สำเร็จ');
      } catch(e){ alert('ไม่สามารถนำเข้า JSON ได้: ' + e.message); }
    }

    function handleFilesUpload(files){
      Array.from(files||[]).forEach(file=>{
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            const flat = normalizeImported(parsed);
            addSet({ filename: file.name, questions: flat, groupName: baseName(file.name), passPercent: 70, enabled: true });
          } catch(err){ alert(`ไฟล์ ${file.name} ไม่ใช่ JSON ที่ถูกต้อง: ` + err.message); }
        };
        reader.readAsText(file,'utf-8');
      });
    }

    function exportAll(){ exportAllQuestions(); }

    // ---- Google Sheets flow ----
    function toCsvUrlFromSheetUrl(url){ try{ const u=new URL(url); if(u.pathname.includes('/export') && u.searchParams.get('format')==='csv'){ return u.toString(); } if(u.pathname.includes('/gviz/tq')){ u.searchParams.set('tqx','out:csv'); return u.toString(); } const m=u.pathname.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); const id=m?m[1]:null; let gid=u.searchParams.get('gid') || (u.hash.match(/gid=(\d+)/)||[])[1] || '0'; if(id){ return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`; } return url; } catch(_){ return url; } }

    async function importAnswersFromSheetUrl(url){ const csvUrl=toCsvUrlFromSheetUrl(url); const res=await fetch(csvUrl); if(!res.ok) throw new Error('โหลดข้อมูลไม่ได้ (อาจต้องตั้งค่า Publish/สิทธิ์เข้าถึง)'); const text=await res.text(); const ans=parseAnswerCSV(text); return applyAnswerMap(ans); }

    function exportAnswerTemplateCsv(){ const ids=new Set(); window.SETS.forEach(set=> set.questions.forEach(q=> ids.add(q.id))); const lines=['id,answer']; [...ids].sort((a,b)=>a-b).forEach(id=> lines.push(`${id},`)); const data=lines.join('\n'); const blob=new Blob([data],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`answer_template_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }

    // =========================
    // 6) Modal logic (เลือกวิธีการวาง/นำเข้าเฉลย)
    // =========================
    function openAnsModal(tab='text'){
      const m=$('#ansModal'); if(!m) return; m.hidden=false;
      setAnsTab(tab);
    }
    function closeAnsModal(){ const m=$('#ansModal'); if(m) m.hidden=true; }
    function setAnsTab(tab){
      const tabs={text:'#tabAnsText', csv:'#tabAnsCSV', sheet:'#tabAnsSheet', file:'#tabAnsFile'};
      const panels={text:'#panelAnsText', csv:'#panelAnsCSV', sheet:'#panelAnsSheet', file:'#panelAnsFile'};
      for (const k of Object.keys(tabs)) { $(tabs[k])?.classList.toggle('active', k===tab); $(panels[k])?.setAttribute('hidden', k!==tab); if(k===tab) $(panels[k])?.removeAttribute('hidden'); }
      openAnsModal.activeTab = tab;
      // autofocus
      setTimeout(()=>{
        if (tab==='text') $('#ansText')?.focus();
        else if (tab==='csv') $('#ansCsvText')?.focus();
        else if (tab==='sheet') $('#ansSheetUrl')?.focus();
        else if (tab==='file') $('#ansFile')?.focus();
      }, 0);
    }

    async function handleAnsImport(){
      try{
        const tab = openAnsModal.activeTab || 'text';
        if (tab==='text'){
          const raw = ($('#ansText')?.value||'').trim(); if(!raw){ alert('ยังไม่ได้วางข้อมูล'); return; }
          const ans = parseAnswerKey(raw); const {applied,skipped}=applyAnswerMap(ans);
          alert(`นำเข้าเฉลยเสร็จสิ้น\nอัปเดต ${applied} ข้อ\nข้าม ${skipped} รายการ`);
          closeAnsModal();
        } else if (tab==='csv'){
          const raw = ($('#ansCsvText')?.value||'').trim(); if(!raw){ alert('ยังไม่ได้วาง CSV'); return; }
          const ans = parseAnswerCSV(raw); const {applied,skipped}=applyAnswerMap(ans);
          alert(`นำเข้าเฉลย (CSV) เสร็จสิ้น\nอัปเดต ${applied} ข้อ\nข้าม ${skipped} รายการ`);
          closeAnsModal();
        } else if (tab==='sheet'){
          const url = ($('#ansSheetUrl')?.value||'').trim(); if(!url){ alert('ยังไม่ได้วางลิงก์'); return; }
          const {applied,skipped} = await importAnswersFromSheetUrl(url);
          alert(`นำเข้าเฉลย (Google Sheets) สำเร็จ\nอัปเดต ${applied} ข้อ\nข้าม ${skipped} รายการ`);
          closeAnsModal();
        } else if (tab==='file'){
          const f = $('#ansFile')?.files?.[0]; if(!f){ alert('ยังไม่ได้เลือกไฟล์'); return; }
          const reader=new FileReader(); reader.onload=()=>{ try{ const ans=parseAnswerCSV(reader.result); const {applied,skipped}=applyAnswerMap(ans); alert(`นำเข้าเฉลย (CSV) เสร็จสิ้น\nอัปเดต ${applied} ข้อ\nข้าม ${skipped} รายการ`); closeAnsModal(); }catch(e){ alert('อ่าน CSV ไม่สำเร็จ: '+e.message); } }; reader.readAsText(f,'utf-8');
        }
      }catch(e){ alert('เกิดข้อผิดพลาด: '+ e.message); }
    }

    // =========================
    // 7) Bind events (safe)
    // =========================
    function bindAllEvents(){
      bind('startBtn','click', start);
      bind('submitBtn','click', grade);
      bind('resetBtn','click', resetAll);
      bind('backBtn','click', ()=> { if (state.locked) { alert('เริ่มทำข้อสอบแล้ว จึงไม่สามารถกลับไปหน้าตั้งค่าได้'); return; } showView('setup'); });
      bind('importBtn','click', promptImport);
      bind('importAnsBtn','click', ()=> openAnsModal('text'));
      bind('exportAnsTemplateBtn','click', exportAnswerTemplateCsv);
      bind('exportBtn','click', exportAll);
      bind('themePicker','change', (e)=> applyTheme(e.target.value));
      bind('tab-setup','click', ()=> { if (state.locked) { alert('เริ่มทำข้อสอบแล้ว จึงไม่สามารถกลับไปหน้าตั้งค่าได้'); return; } showView('setup'); });
      bind('tab-quiz','click', ()=> showView('quiz'));
      bind('tab-result','click', ()=> showView('result'));
      bind('uploadJsonBtn','click', ()=> document.getElementById('fileQuestions')?.click());
      bind('fileQuestions','change', (e)=>{ handleFilesUpload(e.target.files); e.target.value=''; });
      bind('goToQuiz','click', ()=> showView('quiz'));

      // Modal events
      bind('ansModalClose','click', closeAnsModal);
      bind('ansModalCancel','click', closeAnsModal);
      bind('ansModalImport','click', handleAnsImport);
      bind('tabAnsText','click', ()=> setAnsTab('text'));
      bind('tabAnsCSV','click', ()=> setAnsTab('csv'));
      bind('tabAnsSheet','click', ()=> setAnsTab('sheet'));
      bind('tabAnsFile','click', ()=> setAnsTab('file'));
      // ESC to close
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeAnsModal(); } });
    }

    // =========================
    // 8) Self tests (sanity)
    // =========================
    function runSelfTests(){ try { console.group('%cSelf Tests','color:#83e0a5');
      console.assert(typeof bind==='function','bind helper exists');

      // T1: answer key parser (text)
      const m1=parseAnswerKey('1:A, 2 C\n3-ก\n4 d');
      console.assert(m1[1]==='A'&&m1[2]==='C'&&m1[3]==='A'&&m1[4]==='D','T1 parser ok');

      // T2: normalizeImported - array of questions
      const n1=normalizeImported([{id:1,text:'t',choices:[{key:'A',text:'x'}]}]);
      console.assert(Array.isArray(n1)&&n1.length===1&&n1[0].id===1,'T2 n1 ok');
      // T3: normalizeImported - array of groups
      const n2=normalizeImported([{group:'G1',questions:[{id:2,text:'t',choices:[{key:'A',text:'x'}]}]}]);
      console.assert(n2[0].group==='G1'&&n2[0].id===2,'T3 n2 ok');
      // T4: normalizeImported - object mapping
      const n3=normalizeImported({G2:[{id:3,text:'t',choices:[{key:'A',text:'x'}]}]});
      console.assert(n3[0].group==='G2'&&n3[0].id===3,'T4 n3 ok');

      // T5: multi-set combine + uid uniqueness + grading per set
      const setA = addSet({ filename:'A.json', questions:[{id:1,text:'qa',choices:[{key:'A',text:'opt'}],answer:'A'}], groupName:'หมวด A', passPercent:100, enabled:true });
      const setB = addSet({ filename:'B.json', questions:[{id:1,text:'qb',choices:[{key:'A',text:'opt'}],answer:'A'},{id:2,text:'qc',choices:[{key:'A',text:'opt'}],answer:'A'}], groupName:'หมวด B', passPercent:50, enabled:true });
      start();
      const uids=state.order.map(q=>q.uid); const uniq=new Set(uids); console.assert(uids.length===uniq.size,'T5 uid unique');
      state.order.forEach(q=> state.selections[q.uid]='A');
      grade();
      console.assert(document.getElementById('resBySet').children.length>=2,'T5 res per set lines');
      resetAll();
      window.SETS = []; NEXT_SID=1; renderSetsList();

      // T6: lock/unlock behavior
      const setC = addSet({ filename:'C.json', questions:[{id:1,text:'x',choices:[{key:'A',text:'o'}],answer:'A'}], groupName:'C', passPercent:0, enabled:true });
      start();
      console.assert(state.locked===true, 'T6 locked after start');
      resetAll();
      const tabSetup=document.getElementById('tab-setup');
      console.assert(state.locked===false && tabSetup && tabSetup.disabled===false, 'T6 unlocked after reset');
      window.SETS = []; NEXT_SID=1; renderSetsList();

      // T7: CSV parser minimal (includes Thai -> A)
      const csv='id,answer\n1,A\n2,ก\n3,"C"';
      const mapCSV=parseAnswerCSV(csv); console.assert(mapCSV[1]==='A' && mapCSV[2]==='A' && mapCSV[3]==='C','T7 csv -> map ok (ก->A)');

      // T7.1: CSV without header
      const csv2='1,A\n2,ก\n3,C';
      const mapCSV2=parseAnswerCSV(csv2); console.assert(mapCSV2[1]==='A' && mapCSV2[2]==='A' && mapCSV2[3]==='C','T7.1 csv no header ok');

      // T8: derive csv URL from Sheets
      const u=toCsvUrlFromSheetUrl('https://docs.google.com/spreadsheets/d/ABC123/edit#gid=0');
      console.assert(u.includes('export?format=csv') && u.includes('gid='),'T8 toCsvUrl ok');

      // T9: canonical mapping 1-4
      console.assert(toCanonKey('1')==='A' && toCanonKey('2')==='B' && toCanonKey('3')==='C' && toCanonKey('4')==='D','T9 canon 1-4 ok');

      // T10: apply answer map with numeric choices vs letter answers
      const setNum = addSet({ filename:'num.json', questions:[{id:1,text:'numQ',choices:[{key:'1',text:'x'},{key:'2',text:'y'},{key:'3',text:'z'},{key:'4',text:'w'}]}], groupName:'Num', passPercent:0, enabled:true });
      const amap = parseAnswerKey('1:C');
      const res = applyAnswerMap(amap);
      console.assert(res.applied===1, 'T10 applied count ok');
      const qnum = window.SETS.find(s=>s.filename==='num.json').questions[0];
      console.assert(qnum.answer==='3', 'T10 mapped C -> choice key 3');

      console.groupEnd(); } catch(err){ console.error('Self test error:', err); } }

    // =========================
    // Boot
    // =========================
    function boot(){
      initTheme();
      initRouter();
      renderSetsList();
      bindAllEvents();
      resetAll();
    }
    if (document.readyState==='loading') { document.addEventListener('DOMContentLoaded', boot); }
    else { boot(); }

    setTimeout(runSelfTests, 0);
  </script>
</body>
</html>
